{"version":3,"file":"infinite_scroll.min.js","names":["resultsElement: HTMLElement | null","onlyImages: boolean","intersectionObserveOptions: IntersectionObserverInit","observer: IntersectionObserver","initialObservedElement: HTMLElement | null"],"sources":["../../../../../client/simple/src/js/main/infinite_scroll.ts"],"sourcesContent":["// SPDX-License-Identifier: AGPL-3.0-or-later\r\n\r\nimport { assertElement, http, settings } from \"../core/toolkit.ts\";\r\n\r\nconst newLoadSpinner = (): HTMLDivElement => {\r\n  return Object.assign(document.createElement(\"div\"), {\r\n    className: \"loader\"\r\n  });\r\n};\r\n\r\nconst loadNextPage = async (onlyImages: boolean, callback: () => void): Promise<void> => {\r\n  const searchForm = document.querySelector<HTMLFormElement>(\"#search\");\r\n  assertElement(searchForm);\r\n\r\n  const form = document.querySelector<HTMLFormElement>(\"#pagination form.next_page\");\r\n  assertElement(form);\r\n\r\n  const action = searchForm.getAttribute(\"action\");\r\n  if (!action) {\r\n    throw new Error(\"Form action not defined\");\r\n  }\r\n\r\n  const paginationElement = document.querySelector<HTMLElement>(\"#pagination\");\r\n  assertElement(paginationElement);\r\n\r\n  paginationElement.replaceChildren(newLoadSpinner());\r\n\r\n  try {\r\n    const res = await http(\"POST\", action, { body: new FormData(form) });\r\n    const nextPage = await res.text();\r\n    if (!nextPage) return;\r\n\r\n    const nextPageDoc = new DOMParser().parseFromString(nextPage, \"text/html\");\r\n    const articleList = nextPageDoc.querySelectorAll<HTMLElement>(\"#urls article\");\r\n    const nextPaginationElement = nextPageDoc.querySelector<HTMLElement>(\"#pagination\");\r\n\r\n    document.querySelector(\"#pagination\")?.remove();\r\n\r\n    const urlsElement = document.querySelector<HTMLElement>(\"#urls\");\r\n    if (!urlsElement) {\r\n      throw new Error(\"URLs element not found\");\r\n    }\r\n\r\n    if (articleList.length > 0 && !onlyImages) {\r\n      // do not add <hr> element when there are only images\r\n      urlsElement.appendChild(document.createElement(\"hr\"));\r\n    }\r\n\r\n    urlsElement.append(...Array.from(articleList));\r\n\r\n    if (nextPaginationElement) {\r\n      const results = document.querySelector<HTMLElement>(\"#results\");\r\n      results?.appendChild(nextPaginationElement);\r\n      callback();\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error loading next page:\", error);\r\n\r\n    const errorElement = Object.assign(document.createElement(\"div\"), {\r\n      textContent: settings.translations?.error_loading_next_page ?? \"Error loading next page\",\r\n      className: \"dialog-error\"\r\n    });\r\n    errorElement.setAttribute(\"role\", \"alert\");\r\n    document.querySelector(\"#pagination\")?.replaceChildren(errorElement);\r\n  }\r\n};\r\n\r\nconst resultsElement: HTMLElement | null = document.getElementById(\"results\");\r\nif (!resultsElement) {\r\n  throw new Error(\"Results element not found\");\r\n}\r\n\r\nconst onlyImages: boolean = resultsElement.classList.contains(\"only_template_images\");\r\nconst observedSelector = \"article.result:last-child\";\r\n\r\nconst intersectionObserveOptions: IntersectionObserverInit = {\r\n  rootMargin: \"320px\"\r\n};\r\n\r\nconst observer: IntersectionObserver = new IntersectionObserver((entries: IntersectionObserverEntry[]) => {\r\n  const [paginationEntry] = entries;\r\n\r\n  if (paginationEntry?.isIntersecting) {\r\n    observer.unobserve(paginationEntry.target);\r\n\r\n    loadNextPage(onlyImages, () => {\r\n      const nextObservedElement = document.querySelector<HTMLElement>(observedSelector);\r\n      if (nextObservedElement) {\r\n        observer.observe(nextObservedElement);\r\n      }\r\n    }).then(() => {\r\n      // wait until promise is resolved\r\n    });\r\n  }\r\n}, intersectionObserveOptions);\r\n\r\nconst initialObservedElement: HTMLElement | null = document.querySelector<HTMLElement>(observedSelector);\r\nif (initialObservedElement) {\r\n  observer.observe(initialObservedElement);\r\n}\r\n"],"mappings":"wDAIA,IAAM,MACG,OAAO,OAAO,SAAS,cAAc,MAAM,CAAE,CAClD,UAAW,SACZ,CAAC,CAGE,EAAe,MAAO,EAAqB,IAAwC,CACvF,IAAM,EAAa,SAAS,cAA+B,UAAU,CACrE,EAAc,EAAW,CAEzB,IAAM,EAAO,SAAS,cAA+B,6BAA6B,CAClF,EAAc,EAAK,CAEnB,IAAM,EAAS,EAAW,aAAa,SAAS,CAChD,GAAI,CAAC,EACH,MAAU,MAAM,0BAA0B,CAG5C,IAAM,EAAoB,SAAS,cAA2B,cAAc,CAC5E,EAAc,EAAkB,CAEhC,EAAkB,gBAAgB,GAAgB,CAAC,CAEnD,GAAI,CAEF,IAAM,EAAW,MADL,MAAM,EAAK,OAAQ,EAAQ,CAAE,KAAM,IAAI,SAAS,EAAK,CAAE,CAAC,EACzC,MAAM,CACjC,GAAI,CAAC,EAAU,OAEf,IAAM,EAAc,IAAI,WAAW,CAAC,gBAAgB,EAAU,YAAY,CACpE,EAAc,EAAY,iBAA8B,gBAAgB,CACxE,EAAwB,EAAY,cAA2B,cAAc,CAEnF,SAAS,cAAc,cAAc,EAAE,QAAQ,CAE/C,IAAM,EAAc,SAAS,cAA2B,QAAQ,CAChE,GAAI,CAAC,EACH,MAAU,MAAM,yBAAyB,CAGvC,EAAY,OAAS,GAAK,CAAC,GAE7B,EAAY,YAAY,SAAS,cAAc,KAAK,CAAC,CAGvD,EAAY,OAAO,GAAG,MAAM,KAAK,EAAY,CAAC,CAE1C,IACc,SAAS,cAA2B,WAAW,EACtD,YAAY,EAAsB,CAC3C,GAAU,QAEL,EAAO,CACd,QAAQ,MAAM,2BAA4B,EAAM,CAEhD,IAAM,EAAe,OAAO,OAAO,SAAS,cAAc,MAAM,CAAE,CAChE,YAAa,EAAS,cAAc,yBAA2B,0BAC/D,UAAW,eACZ,CAAC,CACF,EAAa,aAAa,OAAQ,QAAQ,CAC1C,SAAS,cAAc,cAAc,EAAE,gBAAgB,EAAa,GAIlEA,EAAqC,SAAS,eAAe,UAAU,CAC7E,GAAI,CAAC,EACH,MAAU,MAAM,4BAA4B,CAG9C,IAAMC,EAAsB,EAAe,UAAU,SAAS,uBAAuB,CAC/E,EAAmB,4BAMnBE,EAAiC,IAAI,qBAAsB,GAAyC,CACxG,GAAM,CAAC,GAAmB,EAEtB,GAAiB,iBACnB,EAAS,UAAU,EAAgB,OAAO,CAE1C,EAAa,MAAkB,CAC7B,IAAM,EAAsB,SAAS,cAA2B,EAAiB,CAC7E,GACF,EAAS,QAAQ,EAAoB,EAEvC,CAAC,SAAW,GAEZ,GAjBuD,CAC3D,WAAY,QACb,CAiB6B,CAExBC,EAA6C,SAAS,cAA2B,EAAiB,CACpG,GACF,EAAS,QAAQ,EAAuB"}